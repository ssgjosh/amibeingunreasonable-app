
<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for app/api/judge/route.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../../index.html">All files</a> / <a href="index.html">app/api/judge</a> route.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>0/136</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>0/46</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>0/9</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>0/132</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line low'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a>
<a name='L40'></a><a href='#L40'>40</a>
<a name='L41'></a><a href='#L41'>41</a>
<a name='L42'></a><a href='#L42'>42</a>
<a name='L43'></a><a href='#L43'>43</a>
<a name='L44'></a><a href='#L44'>44</a>
<a name='L45'></a><a href='#L45'>45</a>
<a name='L46'></a><a href='#L46'>46</a>
<a name='L47'></a><a href='#L47'>47</a>
<a name='L48'></a><a href='#L48'>48</a>
<a name='L49'></a><a href='#L49'>49</a>
<a name='L50'></a><a href='#L50'>50</a>
<a name='L51'></a><a href='#L51'>51</a>
<a name='L52'></a><a href='#L52'>52</a>
<a name='L53'></a><a href='#L53'>53</a>
<a name='L54'></a><a href='#L54'>54</a>
<a name='L55'></a><a href='#L55'>55</a>
<a name='L56'></a><a href='#L56'>56</a>
<a name='L57'></a><a href='#L57'>57</a>
<a name='L58'></a><a href='#L58'>58</a>
<a name='L59'></a><a href='#L59'>59</a>
<a name='L60'></a><a href='#L60'>60</a>
<a name='L61'></a><a href='#L61'>61</a>
<a name='L62'></a><a href='#L62'>62</a>
<a name='L63'></a><a href='#L63'>63</a>
<a name='L64'></a><a href='#L64'>64</a>
<a name='L65'></a><a href='#L65'>65</a>
<a name='L66'></a><a href='#L66'>66</a>
<a name='L67'></a><a href='#L67'>67</a>
<a name='L68'></a><a href='#L68'>68</a>
<a name='L69'></a><a href='#L69'>69</a>
<a name='L70'></a><a href='#L70'>70</a>
<a name='L71'></a><a href='#L71'>71</a>
<a name='L72'></a><a href='#L72'>72</a>
<a name='L73'></a><a href='#L73'>73</a>
<a name='L74'></a><a href='#L74'>74</a>
<a name='L75'></a><a href='#L75'>75</a>
<a name='L76'></a><a href='#L76'>76</a>
<a name='L77'></a><a href='#L77'>77</a>
<a name='L78'></a><a href='#L78'>78</a>
<a name='L79'></a><a href='#L79'>79</a>
<a name='L80'></a><a href='#L80'>80</a>
<a name='L81'></a><a href='#L81'>81</a>
<a name='L82'></a><a href='#L82'>82</a>
<a name='L83'></a><a href='#L83'>83</a>
<a name='L84'></a><a href='#L84'>84</a>
<a name='L85'></a><a href='#L85'>85</a>
<a name='L86'></a><a href='#L86'>86</a>
<a name='L87'></a><a href='#L87'>87</a>
<a name='L88'></a><a href='#L88'>88</a>
<a name='L89'></a><a href='#L89'>89</a>
<a name='L90'></a><a href='#L90'>90</a>
<a name='L91'></a><a href='#L91'>91</a>
<a name='L92'></a><a href='#L92'>92</a>
<a name='L93'></a><a href='#L93'>93</a>
<a name='L94'></a><a href='#L94'>94</a>
<a name='L95'></a><a href='#L95'>95</a>
<a name='L96'></a><a href='#L96'>96</a>
<a name='L97'></a><a href='#L97'>97</a>
<a name='L98'></a><a href='#L98'>98</a>
<a name='L99'></a><a href='#L99'>99</a>
<a name='L100'></a><a href='#L100'>100</a>
<a name='L101'></a><a href='#L101'>101</a>
<a name='L102'></a><a href='#L102'>102</a>
<a name='L103'></a><a href='#L103'>103</a>
<a name='L104'></a><a href='#L104'>104</a>
<a name='L105'></a><a href='#L105'>105</a>
<a name='L106'></a><a href='#L106'>106</a>
<a name='L107'></a><a href='#L107'>107</a>
<a name='L108'></a><a href='#L108'>108</a>
<a name='L109'></a><a href='#L109'>109</a>
<a name='L110'></a><a href='#L110'>110</a>
<a name='L111'></a><a href='#L111'>111</a>
<a name='L112'></a><a href='#L112'>112</a>
<a name='L113'></a><a href='#L113'>113</a>
<a name='L114'></a><a href='#L114'>114</a>
<a name='L115'></a><a href='#L115'>115</a>
<a name='L116'></a><a href='#L116'>116</a>
<a name='L117'></a><a href='#L117'>117</a>
<a name='L118'></a><a href='#L118'>118</a>
<a name='L119'></a><a href='#L119'>119</a>
<a name='L120'></a><a href='#L120'>120</a>
<a name='L121'></a><a href='#L121'>121</a>
<a name='L122'></a><a href='#L122'>122</a>
<a name='L123'></a><a href='#L123'>123</a>
<a name='L124'></a><a href='#L124'>124</a>
<a name='L125'></a><a href='#L125'>125</a>
<a name='L126'></a><a href='#L126'>126</a>
<a name='L127'></a><a href='#L127'>127</a>
<a name='L128'></a><a href='#L128'>128</a>
<a name='L129'></a><a href='#L129'>129</a>
<a name='L130'></a><a href='#L130'>130</a>
<a name='L131'></a><a href='#L131'>131</a>
<a name='L132'></a><a href='#L132'>132</a>
<a name='L133'></a><a href='#L133'>133</a>
<a name='L134'></a><a href='#L134'>134</a>
<a name='L135'></a><a href='#L135'>135</a>
<a name='L136'></a><a href='#L136'>136</a>
<a name='L137'></a><a href='#L137'>137</a>
<a name='L138'></a><a href='#L138'>138</a>
<a name='L139'></a><a href='#L139'>139</a>
<a name='L140'></a><a href='#L140'>140</a>
<a name='L141'></a><a href='#L141'>141</a>
<a name='L142'></a><a href='#L142'>142</a>
<a name='L143'></a><a href='#L143'>143</a>
<a name='L144'></a><a href='#L144'>144</a>
<a name='L145'></a><a href='#L145'>145</a>
<a name='L146'></a><a href='#L146'>146</a>
<a name='L147'></a><a href='#L147'>147</a>
<a name='L148'></a><a href='#L148'>148</a>
<a name='L149'></a><a href='#L149'>149</a>
<a name='L150'></a><a href='#L150'>150</a>
<a name='L151'></a><a href='#L151'>151</a>
<a name='L152'></a><a href='#L152'>152</a>
<a name='L153'></a><a href='#L153'>153</a>
<a name='L154'></a><a href='#L154'>154</a>
<a name='L155'></a><a href='#L155'>155</a>
<a name='L156'></a><a href='#L156'>156</a>
<a name='L157'></a><a href='#L157'>157</a>
<a name='L158'></a><a href='#L158'>158</a>
<a name='L159'></a><a href='#L159'>159</a>
<a name='L160'></a><a href='#L160'>160</a>
<a name='L161'></a><a href='#L161'>161</a>
<a name='L162'></a><a href='#L162'>162</a>
<a name='L163'></a><a href='#L163'>163</a>
<a name='L164'></a><a href='#L164'>164</a>
<a name='L165'></a><a href='#L165'>165</a>
<a name='L166'></a><a href='#L166'>166</a>
<a name='L167'></a><a href='#L167'>167</a>
<a name='L168'></a><a href='#L168'>168</a>
<a name='L169'></a><a href='#L169'>169</a>
<a name='L170'></a><a href='#L170'>170</a>
<a name='L171'></a><a href='#L171'>171</a>
<a name='L172'></a><a href='#L172'>172</a>
<a name='L173'></a><a href='#L173'>173</a>
<a name='L174'></a><a href='#L174'>174</a>
<a name='L175'></a><a href='#L175'>175</a>
<a name='L176'></a><a href='#L176'>176</a>
<a name='L177'></a><a href='#L177'>177</a>
<a name='L178'></a><a href='#L178'>178</a>
<a name='L179'></a><a href='#L179'>179</a>
<a name='L180'></a><a href='#L180'>180</a>
<a name='L181'></a><a href='#L181'>181</a>
<a name='L182'></a><a href='#L182'>182</a>
<a name='L183'></a><a href='#L183'>183</a>
<a name='L184'></a><a href='#L184'>184</a>
<a name='L185'></a><a href='#L185'>185</a>
<a name='L186'></a><a href='#L186'>186</a>
<a name='L187'></a><a href='#L187'>187</a>
<a name='L188'></a><a href='#L188'>188</a>
<a name='L189'></a><a href='#L189'>189</a>
<a name='L190'></a><a href='#L190'>190</a>
<a name='L191'></a><a href='#L191'>191</a>
<a name='L192'></a><a href='#L192'>192</a>
<a name='L193'></a><a href='#L193'>193</a>
<a name='L194'></a><a href='#L194'>194</a>
<a name='L195'></a><a href='#L195'>195</a>
<a name='L196'></a><a href='#L196'>196</a>
<a name='L197'></a><a href='#L197'>197</a>
<a name='L198'></a><a href='#L198'>198</a>
<a name='L199'></a><a href='#L199'>199</a>
<a name='L200'></a><a href='#L200'>200</a>
<a name='L201'></a><a href='#L201'>201</a>
<a name='L202'></a><a href='#L202'>202</a>
<a name='L203'></a><a href='#L203'>203</a>
<a name='L204'></a><a href='#L204'>204</a>
<a name='L205'></a><a href='#L205'>205</a>
<a name='L206'></a><a href='#L206'>206</a>
<a name='L207'></a><a href='#L207'>207</a>
<a name='L208'></a><a href='#L208'>208</a>
<a name='L209'></a><a href='#L209'>209</a>
<a name='L210'></a><a href='#L210'>210</a>
<a name='L211'></a><a href='#L211'>211</a>
<a name='L212'></a><a href='#L212'>212</a>
<a name='L213'></a><a href='#L213'>213</a>
<a name='L214'></a><a href='#L214'>214</a>
<a name='L215'></a><a href='#L215'>215</a>
<a name='L216'></a><a href='#L216'>216</a>
<a name='L217'></a><a href='#L217'>217</a>
<a name='L218'></a><a href='#L218'>218</a>
<a name='L219'></a><a href='#L219'>219</a>
<a name='L220'></a><a href='#L220'>220</a>
<a name='L221'></a><a href='#L221'>221</a>
<a name='L222'></a><a href='#L222'>222</a>
<a name='L223'></a><a href='#L223'>223</a>
<a name='L224'></a><a href='#L224'>224</a>
<a name='L225'></a><a href='#L225'>225</a>
<a name='L226'></a><a href='#L226'>226</a>
<a name='L227'></a><a href='#L227'>227</a>
<a name='L228'></a><a href='#L228'>228</a>
<a name='L229'></a><a href='#L229'>229</a>
<a name='L230'></a><a href='#L230'>230</a>
<a name='L231'></a><a href='#L231'>231</a>
<a name='L232'></a><a href='#L232'>232</a>
<a name='L233'></a><a href='#L233'>233</a>
<a name='L234'></a><a href='#L234'>234</a>
<a name='L235'></a><a href='#L235'>235</a>
<a name='L236'></a><a href='#L236'>236</a>
<a name='L237'></a><a href='#L237'>237</a>
<a name='L238'></a><a href='#L238'>238</a>
<a name='L239'></a><a href='#L239'>239</a>
<a name='L240'></a><a href='#L240'>240</a>
<a name='L241'></a><a href='#L241'>241</a>
<a name='L242'></a><a href='#L242'>242</a>
<a name='L243'></a><a href='#L243'>243</a>
<a name='L244'></a><a href='#L244'>244</a>
<a name='L245'></a><a href='#L245'>245</a>
<a name='L246'></a><a href='#L246'>246</a>
<a name='L247'></a><a href='#L247'>247</a>
<a name='L248'></a><a href='#L248'>248</a>
<a name='L249'></a><a href='#L249'>249</a>
<a name='L250'></a><a href='#L250'>250</a>
<a name='L251'></a><a href='#L251'>251</a>
<a name='L252'></a><a href='#L252'>252</a>
<a name='L253'></a><a href='#L253'>253</a>
<a name='L254'></a><a href='#L254'>254</a>
<a name='L255'></a><a href='#L255'>255</a>
<a name='L256'></a><a href='#L256'>256</a>
<a name='L257'></a><a href='#L257'>257</a>
<a name='L258'></a><a href='#L258'>258</a>
<a name='L259'></a><a href='#L259'>259</a>
<a name='L260'></a><a href='#L260'>260</a>
<a name='L261'></a><a href='#L261'>261</a>
<a name='L262'></a><a href='#L262'>262</a>
<a name='L263'></a><a href='#L263'>263</a>
<a name='L264'></a><a href='#L264'>264</a>
<a name='L265'></a><a href='#L265'>265</a>
<a name='L266'></a><a href='#L266'>266</a>
<a name='L267'></a><a href='#L267'>267</a>
<a name='L268'></a><a href='#L268'>268</a>
<a name='L269'></a><a href='#L269'>269</a>
<a name='L270'></a><a href='#L270'>270</a>
<a name='L271'></a><a href='#L271'>271</a>
<a name='L272'></a><a href='#L272'>272</a>
<a name='L273'></a><a href='#L273'>273</a>
<a name='L274'></a><a href='#L274'>274</a>
<a name='L275'></a><a href='#L275'>275</a>
<a name='L276'></a><a href='#L276'>276</a>
<a name='L277'></a><a href='#L277'>277</a>
<a name='L278'></a><a href='#L278'>278</a>
<a name='L279'></a><a href='#L279'>279</a>
<a name='L280'></a><a href='#L280'>280</a>
<a name='L281'></a><a href='#L281'>281</a>
<a name='L282'></a><a href='#L282'>282</a>
<a name='L283'></a><a href='#L283'>283</a>
<a name='L284'></a><a href='#L284'>284</a>
<a name='L285'></a><a href='#L285'>285</a>
<a name='L286'></a><a href='#L286'>286</a>
<a name='L287'></a><a href='#L287'>287</a>
<a name='L288'></a><a href='#L288'>288</a>
<a name='L289'></a><a href='#L289'>289</a>
<a name='L290'></a><a href='#L290'>290</a>
<a name='L291'></a><a href='#L291'>291</a>
<a name='L292'></a><a href='#L292'>292</a>
<a name='L293'></a><a href='#L293'>293</a>
<a name='L294'></a><a href='#L294'>294</a>
<a name='L295'></a><a href='#L295'>295</a>
<a name='L296'></a><a href='#L296'>296</a>
<a name='L297'></a><a href='#L297'>297</a>
<a name='L298'></a><a href='#L298'>298</a>
<a name='L299'></a><a href='#L299'>299</a>
<a name='L300'></a><a href='#L300'>300</a>
<a name='L301'></a><a href='#L301'>301</a>
<a name='L302'></a><a href='#L302'>302</a>
<a name='L303'></a><a href='#L303'>303</a>
<a name='L304'></a><a href='#L304'>304</a>
<a name='L305'></a><a href='#L305'>305</a>
<a name='L306'></a><a href='#L306'>306</a>
<a name='L307'></a><a href='#L307'>307</a>
<a name='L308'></a><a href='#L308'>308</a>
<a name='L309'></a><a href='#L309'>309</a>
<a name='L310'></a><a href='#L310'>310</a>
<a name='L311'></a><a href='#L311'>311</a></td><td class="line-coverage quiet"><span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { NextResponse } from <span class="cstat-no" title="statement not covered" >'next/server';</span>
import { HarmCategory, HarmBlockThreshold, GenerativeModel } from <span class="cstat-no" title="statement not covered" >'@google/generative-ai';</span>
import { therapistPersona } from <span class="cstat-no" title="statement not covered" >'@/app/prompts/therapist';</span>
import { analystPersona } from <span class="cstat-no" title="statement not covered" >'@/app/prompts/analyst';</span>
import { coachPersona } from <span class="cstat-no" title="statement not covered" >'@/app/prompts/coach';</span>
import { JudgeSchema, JudgeResultValidated } from <span class="cstat-no" title="statement not covered" >'@/lib/validateJudge';</span>
import { retrieveSnippets } from <span class="cstat-no" title="statement not covered" >'@/lib/retrieveSnippets';</span>
import { getGemini } from <span class="cstat-no" title="statement not covered" >'../../../lib/geminiClient';</span>
import { WHITELISTED_SOURCES } from <span class="cstat-no" title="statement not covered" >'@/lib/approvedSources'; // Added: Import for type guard</span>
&nbsp;
// --- Define Approved Domain Type and Type Guard ---
type ApprovedDomain = keyof typeof WHITELISTED_SOURCES;
&nbsp;
function <span class="fstat-no" title="function not covered" >isApprovedDomain(d</span>omain: string): domain is ApprovedDomain {
<span class="cstat-no" title="statement not covered" >    return domain in WHITELISTED_SOURCES;</span>
}
&nbsp;
// --- Define the JudgeResult Interface (for inclusion in the prompt) ---
const judgeResultInterfaceString = <span class="cstat-no" title="statement not covered" >`</span>
interface JudgeResult {
  paraphrase: string; // A concise one-sentence summary from your perspective (max 25-30 words)
  personas: {
    name: "Therapist" | "Analyst" | "Coach"; // The specific persona providing the verdict
    verdict: "Yes" | "No" | "Partially"; // The persona's judgment on your query
    rationale: string; // The reasoning behind the verdict (target &lt;= 120 words) - MUST cite references like [1] if provided
    key_points: [string, string, string]; // Three distinct key takeaways or observations
  }[]; // Array containing results from Therapist, Analyst, and Coach IN THAT ORDER.
  summary: string; // A unified verdict and actionable advice, starting directly with the verdict sentence (target &lt;= 120 words) - MUST cite references like [1] if provided
}
`;
&nbsp;
// --- Helper Function: AI Call with Retry and Validation ---
async function <span class="fstat-no" title="function not covered" >callGenerativeAIWithRetry(</span>
    model: GenerativeModel,
    prompt: string,
    numSnippets: number
): Promise&lt;{ success: true; data: JudgeResultValidated } | { success: false; error: string; details?: any; status: number }&gt; {
    let retryCount = <span class="cstat-no" title="statement not covered" >0;</span>
    let lastError: { error: string; details?: any; status: number } | null = <span class="cstat-no" title="statement not covered" >null;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    while (retryCount &lt;= 1) { // Allow one retry (total 2 attempts)</span>
<span class="cstat-no" title="statement not covered" >        try {</span>
<span class="cstat-no" title="statement not covered" >            console.log(`Judge Route: Attempt ${retryCount + 1} - Sending prompt to AI model...`);</span>
            const result = <span class="cstat-no" title="statement not covered" >await model.generateContent(prompt);</span>
            const response = <span class="cstat-no" title="statement not covered" >await result.response;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            <span class="missing-if-branch" title="if path not taken" >I</span>if (!response || !response.text) {</span>
<span class="cstat-no" title="statement not covered" >                console.error(`Judge Route: Attempt ${retryCount + 1} - Empty response received from AI model.`);</span>
<span class="cstat-no" title="statement not covered" >                lastError = { error: "AI model returned an empty response.", status: 500 };</span>
<span class="cstat-no" title="statement not covered" >                retryCount++;</span>
<span class="cstat-no" title="statement not covered" >                continue;</span>
            }
&nbsp;
            const rawText = <span class="cstat-no" title="statement not covered" >response.text();</span>
<span class="cstat-no" title="statement not covered" >            console.log(`Judge Route: Attempt ${retryCount + 1} - Raw AI Response Text (start):`, rawText.substring(0, 100) + "...");</span>
&nbsp;
            // --- Strict JSON Parsing ---
            let parsedJson: any;
<span class="cstat-no" title="statement not covered" >            try {</span>
<span class="cstat-no" title="statement not covered" >                parsedJson = JSON.parse(rawText);</span>
            } catch (e) {
<span class="cstat-no" title="statement not covered" >                console.error(`Judge Route: Attempt ${retryCount + 1} - Failed to parse AI response as JSON:`, e);</span>
<span class="cstat-no" title="statement not covered" >                console.error(`Judge Route: Attempt ${retryCount + 1} - Failing Raw Text:`, rawText);</span>
<span class="cstat-no" title="statement not covered" >                lastError = { error: "Invalid JSON response from model.", details: rawText, status: 400 };</span>
<span class="cstat-no" title="statement not covered" >                retryCount++;</span>
<span class="cstat-no" title="statement not covered" >                continue;</span>
            }
&nbsp;
            // --- Zod Validation ---
            const validationResult = <span class="cstat-no" title="statement not covered" >JudgeSchema.safeParse(parsedJson);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            <span class="missing-if-branch" title="if path not taken" >I</span>if (!validationResult.success) {</span>
<span class="cstat-no" title="statement not covered" >                console.warn(`Judge Route: Attempt ${retryCount + 1} - Zod validation failed.`);</span>
<span class="cstat-no" title="statement not covered" >                console.error("Zod Errors:", JSON.stringify(validationResult.error.flatten(), null, 2));</span>
<span class="cstat-no" title="statement not covered" >                lastError = {</span>
                    error: "AI response failed validation.",
                    details: {
                        message: "The structure or content of the AI's JSON response did not match the expected format.",
                        zodErrors: validationResult.error.flatten()
                    },
                    status: 400
                };
<span class="cstat-no" title="statement not covered" >                retryCount++;</span>
<span class="cstat-no" title="statement not covered" >                continue;</span>
            }
&nbsp;
            // --- Citation Validation ---
            const validatedData = <span class="cstat-no" title="statement not covered" >validationResult.data;</span>
<span class="cstat-no" title="statement not covered" >            if (numSnippets &gt; 0) {</span>
                const textToCheck = <span class="cstat-no" title="statement not covered" >`${validatedData.summary} ${validatedData.personas.map(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >p</span>.rationale)</span>.join(' ')}`;</span>
                const citationsUsed = <span class="cstat-no" title="statement not covered" >textToCheck.match(/\[(\d+)\]/g)?.map(<span class="fstat-no" title="function not covered" >match =&gt; <span class="cstat-no" title="statement not covered" >p</span>arseInt(match.slice(1, -1))) ?? [</span>];</span>
                const invalidCitations = <span class="cstat-no" title="statement not covered" >citationsUsed.filter(<span class="fstat-no" title="function not covered" >num =&gt; <span class="cstat-no" title="statement not covered" >n</span>um &lt;= 0 || num &gt; numSnippets);</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                <span class="missing-if-branch" title="if path not taken" >I</span>if (invalidCitations.length &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >                    console.warn(`Judge Route: Attempt ${retryCount + 1} - Invalid citation found. Used: ${citationsUsed.join(', ')}, Max valid: ${numSnippets}, Invalid: ${invalidCitations.join(', ')}`);</span>
<span class="cstat-no" title="statement not covered" >                    lastError = {</span>
                        error: "AI response cited invalid reference number.",
                        details: `Cited [${invalidCitations.join(', ')}] but only ${numSnippets} references were provided.`,
                        status: 400
                    };
<span class="cstat-no" title="statement not covered" >                    if (retryCount === 0) {</span>
<span class="cstat-no" title="statement not covered" >                         console.log(`Judge Route: Retrying due to citation error.`);</span>
<span class="cstat-no" title="statement not covered" >                         retryCount++;</span>
<span class="cstat-no" title="statement not covered" >                         continue;</span>
                    } else {
<span class="cstat-no" title="statement not covered" >                         console.error(`Judge Route: Citation error persisted after retry.`);</span>
<span class="cstat-no" title="statement not covered" >                         return { success: false, ...(lastError ?? { error: "Citation error after retry", status: 400 }) };</span>
                    }
                }
<span class="cstat-no" title="statement not covered" >                 console.log(`Judge Route: Attempt ${retryCount + 1} - Citation validation passed (Used: ${citationsUsed.join(', ') || 'None'}, Provided: ${numSnippets}).`);</span>
            } else {
<span class="cstat-no" title="statement not covered" >                 console.log(`Judge Route: Attempt ${retryCount + 1} - Skipping citation validation as no snippets were provided.`);</span>
            }
&nbsp;
&nbsp;
            // --- Success ---
<span class="cstat-no" title="statement not covered" >            console.log(`Judge Route: Attempt ${retryCount + 1} - Successfully parsed, validated JSON, and checked citations.`);</span>
<span class="cstat-no" title="statement not covered" >            return { success: true, data: validatedData };</span>
&nbsp;
        } catch (error: any) {
<span class="cstat-no" title="statement not covered" >            console.error(`Judge Route: Attempt ${retryCount + 1} - Error during AI generation or processing:`, error);</span>
            let errorMessage = <span class="cstat-no" title="statement not covered" >"An unexpected error occurred during analysis.";</span>
            let statusCode = <span class="cstat-no" title="statement not covered" >500;</span>
            const blockReason = <span class="cstat-no" title="statement not covered" >error?.response?.promptFeedback?.blockReason;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (blockReason) {</span>
<span class="cstat-no" title="statement not covered" >                errorMessage = `Content blocked by safety filters: ${blockReason}`;</span>
<span class="cstat-no" title="statement not covered" >                statusCode = 400;</span>
            } else <span class="cstat-no" title="statement not covered" ><span class="missing-if-branch" title="if path not taken" >I</span>if (error.message) {</span>
<span class="cstat-no" title="statement not covered" >                 if (error.message.includes("API key not valid")) {</span>
<span class="cstat-no" title="statement not covered" >                    errorMessage = "Server configuration error: Invalid API Key.";</span>
<span class="cstat-no" title="statement not covered" >                    statusCode = 500;</span>
                } else <span class="cstat-no" title="statement not covered" >if (error.message.includes("quota") || error.status === 429) {</span>
<span class="cstat-no" title="statement not covered" >                    errorMessage = "API quota exceeded. Please try again later.";</span>
<span class="cstat-no" title="statement not covered" >                    statusCode = 429;</span>
                } else {
<span class="cstat-no" title="statement not covered" >                    errorMessage = `AI generation failed: ${error.message}`;</span>
<span class="cstat-no" title="statement not covered" >                    statusCode = 500;</span>
                }
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            <span class="missing-if-branch" title="if path not taken" >I</span>if (statusCode === 500 || statusCode === 429) {</span>
<span class="cstat-no" title="statement not covered" >                 return { success: false, error: errorMessage, status: statusCode };</span>
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            lastError = { error: errorMessage, status: statusCode };</span>
<span class="cstat-no" title="statement not covered" >            retryCount++;</span>
        }
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    console.error("Judge Route: Failed after maximum retries in callGenerativeAIWithRetry.");</span>
    const finalError = <span class="cstat-no" title="statement not covered" >lastError ?? { error: "Unknown error after retries.", status: 500 };</span>
<span class="cstat-no" title="statement not covered" >    return { success: false, ...finalError };</span>
}
&nbsp;
&nbsp;
// --- API Route Handler ---
export async function <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >POST(r</span></span>equest: Request) {
&nbsp;
  let requestBody;
<span class="cstat-no" title="statement not covered" >  try {</span>
<span class="cstat-no" title="statement not covered" >    requestBody = await request.json();</span>
  } catch (e) {
<span class="cstat-no" title="statement not covered" >    console.error("Judge Route: Error parsing request body:", e);</span>
<span class="cstat-no" title="statement not covered" >    return NextResponse.json({ error: "Invalid request format. Ensure you are sending valid JSON." }, { status: 400 });</span>
  }
&nbsp;
  const { context, query } = <span class="cstat-no" title="statement not covered" >requestBody;</span>
&nbsp;
  // --- Input Validation ---
<span class="cstat-no" title="statement not covered" >  <span class="missing-if-branch" title="if path not taken" >I</span>if (!context || typeof context !== 'string' || context.trim().length &lt; 10) {</span>
<span class="cstat-no" title="statement not covered" >    console.warn("Judge Route: Validation failed: Context insufficient.");</span>
<span class="cstat-no" title="statement not covered" >    return NextResponse.json({ error: "Context description required (min 10 chars)." }, { status: 400 });</span>
  }
<span class="cstat-no" title="statement not covered" >  <span class="missing-if-branch" title="if path not taken" >I</span>if (!query || typeof query !== 'string' || query.trim().length &lt; 5) {</span>
<span class="cstat-no" title="statement not covered" >    console.warn("Judge Route: Validation failed: Query insufficient.");</span>
<span class="cstat-no" title="statement not covered" >    return NextResponse.json({ error: "Specific query/worry required (min 5 chars)." }, { status: 400 });</span>
  }
&nbsp;
  // --- Domain Detection &amp; Snippet Retrieval ---
  // Updated keywords to include new domains
  const domainKeywords: Record&lt;string, string[]&gt; = <span class="cstat-no" title="statement not covered" >{</span>
    parenting: ['parent', 'child', 'baby', 'toddler', 'teenager', 'family', 'discipline', 'kid', 'son', 'daughter'],
    tenancy: ['landlord', 'tenant', 'rent', 'lease', 'repair', 'deposit', 'eviction', 'property', 'flatmate', 'dishes', 'housemate', 'lodger', 'housing'],
    workplace: ['boss', 'colleague', 'job', 'manager', 'hr', 'grievance', 'work', 'employment', 'contract', 'employer', 'employee', 'office'],
    consumer: ['product', 'service', 'refund', 'faulty', 'goods', 'purchase', 'consumer', 'rights', 'contract', 'shop', 'store', 'tv', 'debt', 'money', 'bought'], // Added
    health: ['doctor', 'nhs', 'hospital', 'mental health', 'anxiety', 'depression', 'stress', 'wellbeing', 'illness', 'treatment', 'gp', 'health', 'mind', 'samaritans'], // Added
    equality: ['discrimination', 'equality', 'rights', 'disability', 'race', 'gender', 'religion', 'fairness', 'adjustments', 'equal', 'scope', 'acas'], // Added
  };
  let detectedDomain: string = <span class="cstat-no" title="statement not covered" >'default';</span>
  const lowerContext = <span class="cstat-no" title="statement not covered" >context.toLowerCase();</span>
  const lowerQuery = <span class="cstat-no" title="statement not covered" >query.toLowerCase();</span>
  const combinedText = <span class="cstat-no" title="statement not covered" >`${lowerContext} ${lowerQuery}`;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (const [domain, keywords] of Object.entries(domainKeywords)) {</span>
<span class="cstat-no" title="statement not covered" >    <span class="missing-if-branch" title="if path not taken" >I</span>if (keywords.some(<span class="fstat-no" title="function not covered" >keyword =&gt; <span class="cstat-no" title="statement not covered" >c</span>ombinedText.includes(keyword))) {</span></span>
<span class="cstat-no" title="statement not covered" >      detectedDomain = domain;</span>
<span class="cstat-no" title="statement not covered" >      break;</span>
    }
  }
<span class="cstat-no" title="statement not covered" >  console.log(`Judge Route: Detected domain: ${detectedDomain}`);</span>
&nbsp;
  let snippets: string[] = <span class="cstat-no" title="statement not covered" >[];</span>
  // Use type guard before calling retrieveSnippets
<span class="cstat-no" title="statement not covered" >  if (isApprovedDomain(detectedDomain)) {</span>
<span class="cstat-no" title="statement not covered" >    try {</span>
      // Now detectedDomain is known to be ApprovedDomain, satisfying the function signature
<span class="cstat-no" title="statement not covered" >      snippets = await retrieveSnippets(detectedDomain);</span>
<span class="cstat-no" title="statement not covered" >       console.log(`Judge Route: Retrieved ${snippets.length} snippets for domain ${detectedDomain}.`);</span>
    } catch (error) {
<span class="cstat-no" title="statement not covered" >       console.error(`Judge Route: Error retrieving snippets for domain ${detectedDomain}:`, error);</span>
       // Proceed without snippets on error
    }
  } else <span class="cstat-no" title="statement not covered" ><span class="missing-if-branch" title="if path not taken" >I</span>if (detectedDomain !== 'default') {</span>
      // Log if a domain was detected but isn't in WHITELISTED_SOURCES (shouldn't happen with current logic)
<span class="cstat-no" title="statement not covered" >      console.warn(`Judge Route: Domain '${detectedDomain}' detected but not found in WHITELISTED_SOURCES.`);</span>
  }
&nbsp;
  // --- Define Model Config ---
  const safetySettings = <span class="cstat-no" title="statement not covered" >[</span>
    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE },
  ];
  const generationConfig = <span class="cstat-no" title="statement not covered" >{</span>
    temperature: 0.5,
    maxOutputTokens: 2048,
    responseMimeType: "application/json",
    stopSequences: ["&lt;END_JSON&gt;"]
  };
  const modelName = <span class="cstat-no" title="statement not covered" >"gemini-1.5-flash-latest";</span>
&nbsp;
  // --- Get Gemini Model ---
  let model: GenerativeModel;
<span class="cstat-no" title="statement not covered" >  try {</span>
<span class="cstat-no" title="statement not covered" >      console.log(`Judge Route: Attempting to get Gemini model ('${modelName}')...`);</span>
<span class="cstat-no" title="statement not covered" >      model = await getGemini(modelName, { safetySettings, generationConfig });</span>
<span class="cstat-no" title="statement not covered" >      console.log(`Judge Route: Successfully obtained Gemini model instance.`);</span>
  } catch (error: any) {
<span class="cstat-no" title="statement not covered" >      console.error("Judge Route: Failed to get Gemini model via getGemini helper:", error);</span>
<span class="cstat-no" title="statement not covered" >      return NextResponse.json({</span>
          error: `Failed to initialize AI model: ${error.message}`,
          details: error.cause
      }, { status: 500 });
  }
&nbsp;
  // --- Construct the Prompt ---
  const personaInstructions = <span class="cstat-no" title="statement not covered" >[therapistPersona, analystPersona, coachPersona]</span>
    .map(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >`</span>--- ${p.example.name} Persona --- \nSystem Prompt:\n${p.system}\nExample Output Structure:\n${JSON.stringify(p.example, null, 2)}`)</span>
    .join('\n\n');
&nbsp;
  let referencesBlock = <span class="cstat-no" title="statement not covered" >'';</span>
<span class="cstat-no" title="statement not covered" >  <span class="missing-if-branch" title="if path not taken" >I</span>if (snippets.length &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >    referencesBlock = '&lt;REFERENCES&gt;\n';</span>
<span class="cstat-no" title="statement not covered" >    snippets.forEach(<span class="fstat-no" title="function not covered" >(s</span>nippet, index) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      referencesBlock += `[${index + 1}] ${snippet}\n`;</span>
    });
<span class="cstat-no" title="statement not covered" >    referencesBlock += '&lt;/REFERENCES&gt;\n\n';</span>
  }
&nbsp;
  const fullPrompt = <span class="cstat-no" title="statement not covered" >`</span>
You are an AI assistant tasked with analyzing the situation and query provided by the person asking ('you') from multiple perspectives and returning a structured JSON response. Address 'you' directly in your analysis where appropriate.
&nbsp;
**CRITICAL INSTRUCTION:** Your *entire* response MUST be a single, valid JSON object conforming *exactly* to the TypeScript interface provided below. Do NOT include any text, markdown formatting (like \`\`\`json), or explanations before or after the JSON object. Ensure you return all three personas (Therapist, Analyst, Coach) every time, in that specific order. Adhere strictly to the field names, types, and constraints (like string lengths) defined in the schema.
&nbsp;
**TypeScript Interface Definition (for AI guidance):**
\`\`\`typescript
${judgeResultInterfaceString}
\`\`\`
&nbsp;
**Persona Roles &amp; Examples:**
${personaInstructions}
&nbsp;
${referencesBlock} {/* Inserted References Block */}
&nbsp;
**Task:**
Based *exclusively* on the context and query provided by 'you' below, generate the JSON object according to the interface and persona instructions.
&nbsp;
**Your Context:**
"""
${context}
"""
&nbsp;
**Your Specific Query/Worry:**
"${query}"
&nbsp;
**Output Requirements:**
1.  Generate the 'paraphrase' field: A single, concise sentence (max 25-30 words) summarizing the core conflict/situation from your perspective, using British English.
2.  Generate the 'personas' array: Include entries for "Therapist", "Analyst", and "Coach" IN THAT ORDER. Each entry must follow the structure defined in the interface and adhere to the specific system prompts and word counts provided for that persona. Use British English. Address 'you' directly in the rationale. Ensure 'key_points' is always an array of exactly three non-empty strings.
3.  Generate the 'summary' field: Synthesize the key findings into a unified verdict and actionable advice. Start *directly* with the verdict sentence answering your query. Use British English. Your summary must be 120 words max. Address 'you' directly.
4.  Ensure the entire output is *only* the valid JSON object. Use the stop sequence "&lt;END_JSON&gt;" if necessary, but ideally, the JSON object should be the complete response.
5.  **Citation Rules (Added):**
    *   If a &lt;REFERENCES&gt; block is provided above, you MUST cite the sources in your 'rationale' and 'summary' fields using square brackets (e.g., "as stated in the guidance [1]").
    *   Cite *only* the numbers provided in the &lt;REFERENCES&gt; block (e.g., if only [1] and [2] are provided, do not cite [3]).
    *   Aim to incorporate at least one relevant citation if references are provided.
6.  If no &lt;REFERENCES&gt; block is provided, do NOT invent any citations or use bracketed numbers like [1].
&nbsp;
**Your JSON Response:**
`;
&nbsp;
  // --- Call AI Model ---
  const result = <span class="cstat-no" title="statement not covered" >await callGenerativeAIWithRetry(model, fullPrompt, snippets.length);</span>
&nbsp;
  // --- Handle Result ---
<span class="cstat-no" title="statement not covered" >  if (result.success) {</span>
<span class="cstat-no" title="statement not covered" >    return NextResponse.json(result.data, { status: 200 });</span>
  } else {
<span class="cstat-no" title="statement not covered" >    return NextResponse.json({ error: result.error, details: result.details }, { status: result.status });</span>
  }
}</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-04-18T05:31:29.943Z
            </div>
        <script src="../../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../../sorter.js"></script>
        <script src="../../../block-navigation.js"></script>
    </body>
</html>
    